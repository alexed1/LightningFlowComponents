@isTest
public with sharing class ers_ProcessFlowElementsTest {
    
    static testMethod void ProcessFlowElementsTest() {

        Flow_OneView__c dummyRecord = new Flow_OneView__c();
        insert dummyRecord;

        String elementMetadata1 = '<?xml version="1.0" encoding="UTF-8"?><Flow xmlns="http://soap.sforce.com/2006/04/metadata"><actionCalls><name>Action</name><label>Action</label><locationX>176</locationX><locationY>134</locationY><actionName>ers_SliceText</actionName><actionType>apex</actionType><connector><targetReference>Assignment</targetReference></connector><flowTransactionModel>Automatic</flowTransactionModel><inputParameters><name>reverseSearch</name><value><booleanValue>false</booleanValue></value></inputParameters><inputParameters><name>searchBegin</name><value><stringValue>abc</stringValue></value></inputParameters><inputParameters><name>searchEnd</name></inputParameters><inputParameters><name>sourceText</name><value><stringValue>abcxxxdef</stringValue></value></inputParameters><nameSegment>ers_SliceText</nameSegment><storeOutputAutomatically>true</storeOutputAutomatically><versionSegment>1</versionSegment></actionCalls><apiVersion>59.0</apiVersion><assignments><name>Assignment</name><label>Assignment</label><locationX>176</locationX><locationY>242</locationY><assignmentItems><assignToReference>vVariable</assignToReference><operator>Assign</operator><value><stringValue>abc</stringValue></value></assignmentItems><assignmentItems><assignToReference>colText</assignToReference><operator>Add</operator><value><stringValue>A</stringValue></value></assignmentItems><assignmentItems><assignToReference>colText</assignToReference><operator>Add</operator><value><stringValue>B</stringValue></value></assignmentItems><connector><targetReference>Collection_Processor</targetReference></connector></assignments><collectionProcessors><name>Collection_Processor</name><elementSubtype>SortCollectionProcessor</elementSubtype><label>Collection Processor</label><locationX>176</locationX><locationY>350</locationY><collectionProcessorType>SortCollectionProcessor</collectionProcessorType><collectionReference>colText</collectionReference><connector><targetReference>Record_Create</targetReference></connector><sortOptions><doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst><sortOrder>Asc</sortOrder></sortOptions></collectionProcessors><decisions><name>Decision</name><label>Decision</label><locationX>352</locationX><locationY>1322</locationY><defaultConnector><targetReference>Loop</targetReference></defaultConnector><defaultConnectorLabel>Default Outcome</defaultConnectorLabel><rules><name>A</name><conditionLogic>and</conditionLogic><conditions><leftValueReference>Loop</leftValueReference><operator>EqualTo</operator><rightValue><stringValue>A</stringValue></rightValue></conditions><connector><targetReference>Loop</targetReference></connector><label>A</label></rules></decisions><environments>Default</environments><interviewLabel>Flow OneView - Test Elements {!$Flow.CurrentDateTime}</interviewLabel><label>Flow OneView - Test Elements</label><loops><name>Loop</name><label>Loop</label><locationX>176</locationX><locationY>1214</locationY><collectionReference>colText</collectionReference><iterationOrder>Asc</iterationOrder><nextValueConnector><targetReference>Decision</targetReference></nextValueConnector></loops><processMetadataValues><name>BuilderType</name><value><stringValue>LightningFlowBuilder</stringValue></value></processMetadataValues><processMetadataValues><name>CanvasMode</name><value><stringValue>AUTO_LAYOUT_CANVAS</stringValue></value></processMetadataValues><processMetadataValues><name>OriginBuilderType</name><value><stringValue>LightningFlowBuilder</stringValue></value></processMetadataValues><processType>Flow</processType><recordCreates><name>Record_Create</name><label>Record Create</label><locationX>176</locationX><locationY>458</locationY><connector><targetReference>Record_Lookup</targetReference></connector><inputAssignments><field>Name</field><value><elementReference>vVariable</elementReference></value></inputAssignments><object>Account</object><storeOutputAutomatically>true</storeOutputAutomatically></recordCreates><recordDeletes><name>Record_Delete</name><label>Record Delete</label><locationX>176</locationX><locationY>782</locationY><connector><targetReference>Record_Roll_Back</targetReference></connector><faultConnector><isGoTo>true</isGoTo><targetReference>Subflow</targetReference></faultConnector><inputReference>Record_Lookup</inputReference></recordDeletes><recordLookups><name>Record_Lookup</name><label>Record Lookup</label><locationX>176</locationX><locationY>566</locationY><assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound><connector><targetReference>Record_Update</targetReference></connector><filterLogic>and</filterLogic><filters><field>Name</field><operator>EqualTo</operator><value><stringValue>A</stringValue></value></filters><getFirstRecordOnly>true</getFirstRecordOnly><object>Account</object><storeOutputAutomatically>true</storeOutputAutomatically></recordLookups><recordRollbacks><name>Record_Roll_Back</name><label>Record Roll Back</label><locationX>176</locationX><locationY>890</locationY><connector><targetReference>Subflow</targetReference></connector></recordRollbacks><recordUpdates><name>Record_Update</name><label>Record Update</label><locationX>176</locationX><locationY>674</locationY><connector><targetReference>Record_Delete</targetReference></connector><inputReference>Record_Lookup</inputReference></recordUpdates><screens><name>Screen</name><label>Screen</label><locationX>176</locationX><locationY>1106</locationY><allowBack>true</allowBack><allowFinish>true</allowFinish><allowPause>true</allowPause><connector><targetReference>Loop</targetReference></connector><showFooter>true</showFooter><showHeader>true</showHeader></screens><start><locationX>50</locationX><locationY>0</locationY><connector><targetReference>Action</targetReference></connector></start><status>Draft</status><subflows><name>Subflow</name><label>Subflow</label><locationX>176</locationX><locationY>998</locationY><connector><targetReference>Screen</targetReference></connector><flowName>Flow_OneView_Get_Flow_Details</flowName><storeOutputAutomatically>true</storeOutputAutomatically></subflows><variables><name>colText</name><dataType>String</dataType><isCollection>true</isCollection><isInput>false</isInput><isOutput>false</isOutput></variables><variables><name>vVariable</name><dataType>String</dataType><isCollection>false</isCollection><isInput>false</isInput><isOutput>false</isOutput></variables></Flow>';
        String elementMetadata2 = '<?xml version="1.0" encoding="UTF-8"?><Flow xmlns="http://soap.sforce.com/2006/04/metadata"><apiVersion>59.0</apiVersion><environments>Default</environments><interviewLabel>Flow OneView - Test Elements2 {!$Flow.CurrentDateTime}</interviewLabel><label>Flow OneView - Test Elements2</label><processMetadataValues><name>BuilderType</name><value><stringValue>LightningFlowBuilder</stringValue></value></processMetadataValues><processMetadataValues><name>CanvasMode</name><value><stringValue>AUTO_LAYOUT_CANVAS</stringValue></value></processMetadataValues><processMetadataValues><name>OriginBuilderType</name><value><stringValue>LightningFlowBuilder</stringValue></value></processMetadataValues><processType>AutoLaunchedFlow</processType><start><locationX>50</locationX><locationY>0</locationY><connector><targetReference>Wait_Condition</targetReference></connector></start><status>InvalidDraft</status><transforms><name>Transform</name><label>Transform</label><locationX>176</locationX><locationY>542</locationY><dataType>SObject</dataType><isCollection>false</isCollection><objectType>Account</objectType><scale>0</scale><transformValues><transformValueActions><outputFieldApiName>A_Hidden_Field__c</outputFieldApiName><transformType>Map</transformType><value><elementReference>vText</elementReference></value></transformValueActions></transformValues></transforms><variables><name>vText</name><dataType>String</dataType><isCollection>false</isCollection><isInput>false</isInput><isOutput>false</isOutput></variables><waits><name>Wait_Condition</name><label>Wait Condition</label><locationX>176</locationX><locationY>134</locationY><defaultConnector><targetReference>Wait_Time</targetReference></defaultConnector><defaultConnectorLabel>Default Path</defaultConnectorLabel><waitEvents><name>WaitConfig</name><conditionLogic>and</conditionLogic><connector><targetReference>Wait_Time</targetReference></connector><eventType>AlarmEvent</eventType><inputParameters><name>AlarmTime</name><value><elementReference>$System.OriginDateTime</elementReference></value></inputParameters><inputParameters><name>TimeOffset</name></inputParameters><inputParameters><name>TimeOffsetUnit</name></inputParameters><label>WaitConfig</label></waitEvents></waits><waits><name>Wait_Date</name><elementSubtype>WaitDate</elementSubtype><label>Wait Date</label><locationX>176</locationX><locationY>434</locationY><defaultConnectorLabel>Default Path</defaultConnectorLabel><timeZoneId>America/New_York</timeZoneId><waitEvents><conditionLogic>and</conditionLogic><connector><targetReference>Transform</targetReference></connector><label>el_1</label><offset>0</offset><resumeDate>2023-12-01</resumeDate><resumeTime>00:15:00.000Z</resumeTime></waitEvents></waits><waits><name>Wait_Time</name><elementSubtype>WaitDuration</elementSubtype><label>Wait Time</label><locationX>176</locationX><locationY>326</locationY><defaultConnectorLabel>Default Path</defaultConnectorLabel><waitEvents><conditionLogic>and</conditionLogic><connector><targetReference>Wait_Date</targetReference></connector><label>el_0</label><offset>1</offset><offsetUnit>Days</offsetUnit></waitEvents></waits></Flow>';
        String elementMetadata3 = '<?xml version="1.0" encoding="UTF-8"?><Flow xmlns="http://soap.sforce.com/2006/04/metadata"><apiVersion>59.0</apiVersion><customErrors><name>Custom_Error</name><label>Custom Error</label><locationX>176</locationX><locationY>323</locationY><customErrorMessages><errorMessage>Error Message</errorMessage><isFieldError>false</isFieldError></customErrorMessages></customErrors><environments>Default</environments><interviewLabel>Flow OneView - Test Elements3 {!$Flow.CurrentDateTime}</interviewLabel><label>Flow OneView - Test Elements3</label><processMetadataValues><name>BuilderType</name><value><stringValue>LightningFlowBuilder</stringValue></value></processMetadataValues><processMetadataValues><name>CanvasMode</name><value><stringValue>AUTO_LAYOUT_CANVAS</stringValue></value></processMetadataValues><processMetadataValues><name>OriginBuilderType</name><value><stringValue>LightningFlowBuilder</stringValue></value></processMetadataValues><processType>AutoLaunchedFlow</processType><start><locationX>50</locationX><locationY>0</locationY><connector><targetReference>Custom_Error</targetReference></connector><object>Account</object><recordTriggerType>Create</recordTriggerType><triggerType>RecordAfterSave</triggerType></start><status>Draft</status></Flow>';

        ers_ProcessFlowElements.Requests testRequest = new ers_ProcessFlowElements.Requests();
        List<ers_ProcessFlowElements.Requests> testRequestList = new List<ers_ProcessFlowElements.Requests>();

        // Test Screen Flow
        testRequest.sourceMetadata = elementMetadata1;
        testRequestList.add(testRequest);
        List<ers_ProcessFlowElements.Results> testResultList = ers_ProcessFlowElements.processElements(testRequestList);
        Assert.areEqual('16', String.valueOf(testResultList[0].resourceRecordCollection.size()));
        testRequestList.clear();

        // Test Autolaunched Flow
        testRequest.sourceMetadata = elementMetadata2;
        testRequestList.add(testRequest);
        testResultList = ers_ProcessFlowElements.processElements(testRequestList);
        Assert.areEqual('7', String.valueOf(testResultList[0].resourceRecordCollection.size()));
        testRequestList.clear();

        // Test Record Triggered Flow
        testRequest.sourceMetadata = elementMetadata3;
        testRequestList.add(testRequest);
        testResultList = ers_ProcessFlowElements.processElements(testRequestList);
        Assert.areEqual('2', String.valueOf(testResultList[0].resourceRecordCollection.size()));
        testRequestList.clear();

    }

}